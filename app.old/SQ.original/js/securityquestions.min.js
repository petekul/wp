"use strict";angular.module("SSO.securityquestions",["ui.router","SSO.url","SSO.sessionIdle"]).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("app",{url:"/",views:{header:{templateUrl:"views/header.html"},content:{templateUrl:"views/security-questions/securityquestions.html"},footer:{templateUrl:"views/footer.html"}},onEnter:function(e){e.document.title="For your security | Worldpay Account"}}).state("app.accountdisabled",{views:{"content@":{templateUrl:"views/account-disabled/accountdisabled.html"}},onEnter:function(e){e.document.title="Account disabled | Worldpay Account"}}),t.otherwise(function(e,t){e.invoke(["$state",function(e){e.go("app")}])})}]);var app=angular.module("SSO.url",["ui.router"]);angular.module("SSO.url").service("originService",function(){var e,t;return{storeOrigin:function(){e=document.URL;var n=function(){var t={};e.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(e,n,o){t[n]=o});return t}().backUrl;n||(n="http://www.mybusiness.worldpay.com"),t=n,console.log(t+" has been stored")},getOrigin:function(){return e},getURL:function(){return t}}});(app=angular.module("SSO.url")).controller("urlController",["$scope","$stateParams","$state","urlService",function(e,t,n,o){o.loadURLs().then(function(t){e.logoutURL="/logout?end_url="+o.getDefaultURL()},function(e){void 0==e.status?window.location.href=o.getLogoutURL("statuspage")+"?status_code="+e.status:window.location.href=o.getLogoutURL("statuspage")+"?status_code="+e.message});var i=document.URL;""==i&&(i="http://ukdc2-tc-g1wxs08.wpds.worldpaytd.local:7777/sso/index.html?backUrl=http%3A%2F%2Fmybusiness.wpds.worldpaytd.local%3A7778%2Fmbd.html"),o.storeOrigin(i)}]),angular.module("SSO.url").service("urlService",["$http","$q",function(e,t){var n,o,i=t.defer(),s={};return{loadURLs:function(){var n=e.get("/sso/modules/common/index/environment.json"),o=e.get("/sso/modules/common/index/urls.json");return t.all([n,o]).then(function(e){e[0].data[0].url,s=e[1].data,i.resolve()}),i.promise},getURLs:function(){return s},getURL:function(e){e.includes("config")||(e+="test");return s.filter(function(t){return t.urlName===e})[0].url},getDefaultURL:function(){return s[0].url},getLogoutURL:function(e){var t=s.filter(function(t){return t.urlName===e});return t[0].url},storeOrigin:function(e){n=e;var t=function(){var e={};n.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(t,n,o){e[n]=o});return e}().backUrl;o=decodeURIComponent(t)},getOrigin:function(){return n},getBackURL:function(){return o}}}]);app=angular.module("SSO.sessionIdle",["SSO.url"]);(app=angular.module("SSO.sessionIdle")).directive("sessionIdle",["idleService","urlService",function(e,t){return{templateUrl:"/sso/modules/common/components/session-idle/templates/sessionIdle.tmpl.html",link:function(n,o,i){e.loadConfig(),n.yes=function(){t.loadURLs().then(function(t){e.startTimer()})},n.no=function(){e.logOut()},$("#idleModal").on("hidden.bs.modal",function(t){e.startTimer(),e.hideModal()})}}}]),angular.module("SSO.sessionIdle").service("idleService",["$http","$q","$state","urlService",function(e,t,n,o){var i=0,s=900,r=(t.defer(),function(){$(".modal-backdrop").remove(),$("#idleModal").modal("hide")}),a=function(){clearInterval(i)};return{loadConfig:function(){e.get("/sso/modules/common/components/session-idle/idle.conf.json").then(function(e){s=parseFloat(e.data.timeoutDuration)})},startTimer:function(){var e=(new Date).getTime(),t="0.0";a(),i=setInterval(function(){var n=(new Date).getTime()-e;t=Math.floor(n/100)/10,Math.round(t)==t&&(t+=".0"),t>s-60&&($("#idleModal").is(":hidden")&&$("#idleModal").modal("show"),t>s&&(r(),window.location.href=o.getLogoutURL("statuspage")+"sessiontimeout",a()))},100)},logOut:function(){window.location.href=o.getLogoutURL("statuspage")+"sessiontimeout",a()},timeOut:function(){var e=o.getLogoutURL("statuspage")+"sessiontimeout",t=-1===e.indexOf("?")?"?":"&";window.location.href=e+t+"p_error_code=SSO-1"},hideModal:r}}]),angular.module("SSO.securityquestions").factory("SQService",["$http","$q","urlService",function(e,t,n){var o=$(".scm").attr("class").split(" ")[1];return{getSecurityQuestions:function(t,i){return e.get(n.getURL(o+"SQ"),{headers:{directive:t,backUrl:i}})},loadSQConfig:function(){return e.get(n.getURL("SQconfig"))},postAnswers:function(t,i){return e.post(n.getURL(o+"SQpost"),t,{headers:{"X-CSRF-CUSTOM-TOKEN":"SomeRandomValue",backUrl:i}})},mockPostAnswers:function(t){return e.post("views/security-questions/configs/postSQAPIresponse.json")}}}]);(app=angular.module("SSO.securityquestions")).controller("SQController",["$scope","$stateParams","$state","SQService","urlService","idleService",function(e,t,n,o,i,s){e.questions=[],e.userEmail="someemail";o.getSecurityQuestions({},i.getBackURL()).then(function(t){s.startTimer(),e.userEmail=t.data.userName,e.questions=t.data.securityQuestions,e.originalQuestions=jQuery.extend(!0,[],e.questions),0==e.questions.length||"NOSQ"===e.questions.directive?window.location.href=t.data.nextLink:u()},function(e){window.location.href=i.getLogoutURL("statuspage")+"noSQinfo"}),o.loadSQConfig().then(function(t){s.startTimer();var n=t.data;e.midConfig=n[n.map(e=>e.questionType).indexOf("MID")],e.postcodeConfig=n[n.map(e=>e.questionType).indexOf("POSTCODE")],e.contactConfig=n[n.map(e=>e.questionType).indexOf("LASTNAME")]}),e.onKeyUp=function(t){txtElem="#txtAnswer"+t,incElem="#pIncorrect"+t,$(txtElem).attr("class").includes("MID")&&$(txtElem).val().length>=e.midConfig.minFieldLength?a(txtElem,incElem):$(txtElem).attr("class").includes("POSTCODE")&&$(txtElem).val().length>=e.postcodeConfig.minFieldLength?a(txtElem,incElem):$(txtElem).attr("class").includes("LASTNAME")&&$(txtElem).val().length>e.contactConfig.minFieldLength&&a(txtElem,incElem),"POSTCODE"!=this.questions[t-1].questionType&&"LASTNAME"!=this.questions[t-1].questionType||$(txtElem).val($(txtElem).val().toUpperCase()),l()},e.validateInput=function(t,n){var o=new RegExp;switch(t){case"MID":o=new RegExp(e.midConfig.validRegex);break;case"POSTCODE":o=new RegExp(e.postcodeConfig.validRegex);break;case"LASTNAME":o=new RegExp(e.contactConfig.validRegex)}var i=n||window.event,s=i.keyCode||i.which;8!=s&&(s=String.fromCharCode(s),o.test(s)||(i.returnValue=!1,i.preventDefault&&i.preventDefault()))},e.expand=function(e){e="#"+e,"none"==$(e).css("display")?$(e).css("display","block"):$(e).css("display","none")},e.expandHint=function(t){e.expand(t),iconhintindex="#icon"+t,$(iconhintindex).find("i").toggleClass("glyphicon-question-sign").toggleClass("glyphicon-minus-sign")},e.reloadSQ=function(t){e.questions=t},e.submitForm=function(){var t={};this.questions=jQuery.extend(!0,[],this.originalQuestions);for(var n=0;n<this.originalQuestions.length;n++)ansElem="#txtAnswer"+(n+1),this.questions[n].answer+=$(ansElem).val();$(".content").css("display","none"),$(".loadingAnimation").css("display","block"),t.securityQuestions=this.questions,o.postAnswers(t,i.getBackURL()).then(function(e){if(s.startTimer(),1!=e.data.disabled){if(!(e.data.securityQuestions.length>0))return!0,void(window.location.href=e.data.nextLink);this.reloadSQ(e.data.securityQuestions),!1;for(var t=0;t<this.questions.length;t++)switch(this.questions[t].questionType){case"MID":r("MID");break;case"POSTCODE":r("POSTCODE");break;case"LASTNAME":r("LASTNAME");break;default:console.log("no further questions found")}l(),u()}else window.location.href=i.getLogoutURL("statuspage")+"accountdisabled"}.bind(e),function(e){s.startTimer(),!1,window.location.href=i.getLogoutURL("statuspage")+e.status})};function r(t){for(var n=1;n<=e.originalQuestions.length;n++){var o="#txtAnswer"+n,i="#pIncorrect"+n;if($(o).attr("class").includes(t)){$(o).val(""),$(o).css("border-color","red"),$(i).css("display","block");break}}}function a(e,t){$(t).css("display","none"),$(e).css("border-color","#ccc")}function l(){for(var t=!1,n=!0,o=1;o<=e.questions.length;o++){var i="#txtAnswer"+o;t=n=!($(i).attr("class").includes("LASTNAME")&&$(i).val().length>e.contactConfig.minFieldLength&&!t)&&(!($(i).attr("class").includes("POSTCODE")&&$(i).val().length>=e.postcodeConfig.minFieldLength&&!t)&&!($(i).val().length>=e.midConfig.minFieldLength&&!t))}n?$("#btnSubmitSQ").prop("disabled",!0):$("#btnSubmitSQ").attr("disabled",!1)}function u(){$(".content").css("display","block"),$(".loadingAnimation").css("display","none")}document.addEventListener("invalid",function(e){e.preventDefault()},!0)}]);(app=angular.module("SSO.securityquestions")).controller("accDisabledController",["$scope","$stateParams","$state","urlService",function(e,t,n,o){e.validateInput=function(){document.location.href=o.getLogoutURL()}}]);